<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="rating2.css">
  <script src="rating2.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script>
    var comments = {};
    isExistedComment = () => {
      if (checkExistedComment()) {
        $("#comment-card").hide();
        $("#find-comment").show();
        $("#btn-find-comment").attr('href',`#${getSessionObj('currentUser').uid}`);
        return true;
      } else {
        $("#find-comment").hide();
        $("#comment-card").show();
        return false;
      }
    }

    checkExistedComment = () => {
      var isExisted = false;
      $.each(loadAllComments, (key, value) => {
        if (value.uid === getSessionObj("currentUser").uid) {
          isExisted = true;
          return false;
          // console.log(comments);
        }
      });
      return isExisted;
    }

    saveToComments = (comment) => {
      var id = `c${Object.keys(loadAllComments).length+1}`;
      loadAllComments[id] = comment;
    }

    $(() => {
      //      console.log(selectedResId);
      var restaurant = loadAllRestaurants[selectedResId];
      $("#res-name").text(restaurant.name);
      $("#res-info").text(restaurant.introduction);

      $.each(restaurant.menus, (key, value) => {
        //        console.log(value.name);  //restaurant.menus.m1
        //        console.log(value);
        appendToTab(value);
      });

      // load comments
      $.each(loadAllComments, (key, value) => {
        if (value.rid === selectedResId) {
          comments[key] = value;
          isExistedComment();
          // console.log(comments);
        }
      });

      //show the comments
      $.each(comments, (key, value) => {
        comments[key].icon = loadAllUsers[`u${value.uid}`].icon;
        comments[key].name = loadAllUsers[`u${value.uid}`].username;
        comments[key].type = loadAllUsers[`u${value.uid}`].type;
        // console.log(comments[key].icon);
        appendToComments(value);
      });

      //      $("#star1").attr("class", "fa fa-star checked");
    });

    $("#btn-comment").on("click", () => {
      var comment = {
        uid: getSessionObj("currentUser").uid,
        rid: `r${selectedResId}`,
        date: today(),
        rating: $(".stars.starrr>svg.checked").length,
        content: $("textarea").val(),
        icon: getSessionObj('currentUser').icon,
        name: getSessionObj('currentUser').username,
        type: getSessionObj('currentUser').type,
      };
      // console.log(comment)
      if (!isExistedComment()) {
        appendToComments(comment);
        saveToComments(comment);
        showToast("Your comment is posted!");
      } else {
        showToast("Sorry,You have posted your comment before!", 1);
      }


    });

    function add(ths, sno) {
      $.each($(".stars.starrr>svg"), (key, value) => {
        $(value).attr("class", "fa fa-star");
      });

      var i = 1;
      $.each($(".stars.starrr>svg"), (key, value) => {
        $(value).attr("class", "fa fa-star checked");
        if (i++ >= sno) return false;
      });

    }

    window.appendToTab = (value) => {
      if (value !== null) {
        //        console.log(value);
        //        https://picsum.photos/800
        content = `<div class="tab-pane fade show active" id="menu" role="tabpanel" aria-labelledby="menu-tab">
        <div class="card w-75">
          <div class="row no-gutters">
            <div class="col-auto">
              <img class="card-img" src="img/food_drink/${value.image}" alt="Card image cap" style="width: 150px">
              <p class="text-secondary text-center">${value.type}</p>
              </div>
            <div class="col">
              <div class="card-body px-3">
                <h4 class="card-title">${value.name}</h4>
                <p class="card-text"> Lorem ipsum dolor sit amet, consectetur adipisicing elit. Veritatis quaerat doloribus rerum. Suscipit ea pariatur neque voluptate voluptatem quo adipisci quod aperiam, in beatae minus maiores laborum molestiae voluptatum blanditiis? </p>
              </div>
            </div>
          </div>
        </div>`;

        $("#menu").append(content);
      }
      return content;
    }

    window.appendToComments = (value) => {
      if (value !== null) {
        var rating = ``;
        for (var i = 0; i < value.rating; i++) {
          rating += `<span class="float-right"><i class="text-warning fa fa-star"></i></span>`;
        }
        content = `
         <div class="card" id="${value.uid}">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-2">
                    <img src="./img/user_icon/${value.icon}"  class="img img-rounded img-fluid" style="width: 900px;"/>
                    <p class="text-secondary text-center">${value.type}</p>
                  </div>
                  <div class="col-md-10">
                    <p>
                      <a class="float-left" href="https://maxniruzzaman-akash.blogspot.com/p/contact.html"><strong>${value.name}</strong></a>&nbsp; posted on ${value.date}
                          ${rating};
                    </p>
                    <div class="clearfix"></div>
                    <p>${value.content}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>`;

        $("#comment").append(content);
      }
      return content;
    }
  </script>

</head>

<body>

  <div class="container">

    <div data-toggle="modal" data-target="#myModal">
      <h2 id="res-name">Restaurant Name</h2>
      <p id="res-info">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Fugit quam sit amet, cum eos ipsum ipsa
        sapiente veniam consectetur facilis, minus officia blanditiis. Illum adipisci minima dolorem nulla esse
        doloremque.
      </p>
    </div>


    <!-- Modal -->
    <!--
    <div class="modal fade" id="myModal" role="dialog">
      <div class="modal-dialog">
-->

    <!-- Modal content-->
    <!--
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Modal Header</h4>
          </div>
          <div class="modal-body">
            <p>Some text in the modal.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
-->


    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="menu-tab" data-toggle="tab" href="#menu" role="tab" aria-controls="home"
          aria-selected="true">Menu</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="review-tab" data-toggle="tab" href="#review" role="tab" aria-controls="review"
          aria-selected="false">Review</a>
      </li>
    </ul>
    <!--    MENU TAB-->
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="menu" role="tabpanel" aria-labelledby="menu-tab">
      </div>

      <!--      REVIEW TAB-->
      <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
        <!--       container of comment and rating-->
        <div class="container">
          <div class="row" style="margin-top:40px;">
            <div class="col-md-6">
              <!--              comment card-->
              <div class="card bg-light" id="find-comment">
                <div class="card-body">

                  <div class="text-right">
                    <a class="btn btn-success btn-green" href="#reviews-anchor" id="btn-find-comment">Find your comment</a>
                  </div>
                </div>
              </div>


              <!--              comment card-->
              <div class="card bg-light" id="comment-card">
                <div class="card-body">

                  <div class="text-right">
                    <a class="btn btn-success btn-green" href="#" id="open-review-box">Leave a Review</a>
                  </div>

                  <!--                 reviewbox-->
                  <div class="row" id="post-review-box" style="display:none;">
                    <div class="col-md-12">
                      <form accept-charset="UTF-8" action="" method="post" onsubmit="return false;">
                        <input id="ratings-hidden" name="rating" type="hidden">
                        <textarea class="form-control animated" cols="50" id="new-review" name="comment"
                          placeholder="Enter your review here..." rows="5"></textarea>

                        <!--                       star rating-->
                        <div class="text-right">
                          <div class="stars starrr" data-rating="0">
                            <span class="fa fa-star" id="star1" onclick="add(this,1)"></span>
                            <span class="fa fa-star" id="star2" onclick="add(this,2)"></span>
                            <span class="fa fa-star" id="star3" onclick="add(this,3)"></span>
                            <span class="fa fa-star" id="star4" onclick="add(this,4)"></span>
                            <span class="fa fa-star" id="star5" onclick="add(this,5)"></span>
                          </div>
                          <a class="btn btn-danger btn-sm" href="#" id="close-review-box"
                            style="display:none; margin-right: 10px;">
                            <span class="glyphicon glyphicon-remove"></span>Cancel</a>
                          <button class="btn btn-success btn-lg" id="btn-comment" type="submit">Save</button>
                        </div>
                        <!--                        /star rating-->
                      </form>
                    </div>
                  </div>
                  <!--                  /reviewbox-->
                </div>
              </div>
              <!--              /comment card-->

            </div>
          </div>

          <!--          comment-->
          <div class="row" style="margin-top:40px;" id="comment">
          </div>

          <!--          /comment-->

        </div>
      </div>
    </div>
  </div>


</body>

</html>